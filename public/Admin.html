<script type="module">
  const { createClient } = supabase;
  const supabaseClient = createClient(
    'https://pwxslkkxevuknredmfpb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3eHNsa2t4ZXZ1a25yZWRtZnBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMDA1MDcsImV4cCI6MjA2MDU3NjUwN30.vWwGu6q8mJy5vX1g584qSL73V9F3bhh2RSW-2dNeEc0'
  );

  async function checkSession() {
    const { data } = await supabaseClient.auth.getSession();
    const session = data.session;
    if (!session) return window.location.href = '/login.html';
    document.getElementById('user-email').textContent = `Inloggad som: ${session.user.email}`;
    localStorage.setItem('sb_token', session.access_token);
    loadUsers();
    loadManagers();
  }

  async function loadUsers() {
    const token = localStorage.getItem('sb_token');
    const res = await fetch('/api/users', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    const tbody = document.querySelector('#userTable tbody');
    tbody.innerHTML = '';
    if (data.Resources) {
      data.Resources.forEach(u => {
        const row = `<tr>
          <td>${u.name?.givenName || ''} ${u.name?.familyName || ''}</td>
          <td>${u.employeeNumber || ''}</td>
          <td>${u.emails?.[0]?.value || ''}</td>
          <td>${u.department || ''}</td>
          <td>${u.manager || ''}</td>
          <td>${u.title || ''}</td>
          <td>${u.startDate || ''}</td>
          <td>${u.endDate || ''}</td>
          <td>
            <button onclick="editUser('${u.id}')">Edit</button>
            <button onclick="deleteUser('${u.id}')">Delete</button>
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }
  }

  async function loadManagers() {
    const token = localStorage.getItem('sb_token');
    const res = await fetch('/api/users', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    const select = document.getElementById('manager');
    select.innerHTML = '<option value="">Select Manager</option>';
    if (data.Resources) {
      data.Resources.forEach(u => {
        const fullName = `${u.name?.givenName || ''} ${u.name?.familyName || ''}`.trim();
        const option = document.createElement('option');
        option.value = u.employeeNumber;
        option.textContent = fullName;
        select.appendChild(option);
      });
    }
  }

  window.editUser = async function(id) {
    const token = localStorage.getItem('sb_token');
    const res = await fetch(`/api/users?id=${id}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const user = await res.json();
    if (!user || !user.name) return alert('Kunde inte hämta användardata');

    document.getElementById('editId').value = user.id;
    document.getElementById('first').value = user.name.givenName || '';
    document.getElementById('last').value = user.name.familyName || '';
    document.getElementById('email').value = user.emails?.[0]?.value || '';
    document.getElementById('department').value = user.department || '';
    document.getElementById('manager').value = user.manager || '';
    document.getElementById('title').value = user.title || '';
    document.getElementById('empNum').value = user.employeeNumber || '';
    document.getElementById('start').value = user.startDate || '';
    document.getElementById('end').value = user.endDate || '';
    document.getElementById('formTitle').textContent = 'Edit User';
    document.getElementById('userForm').classList.add('editing');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  checkSession();
</script>
